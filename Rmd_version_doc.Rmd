---
title: "Open data CBS"
author: "Marc A.T. Teunis"
date: "6/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Link https://github.com/statistiekcbs/CBS-Open-Data-v4

## Link https://redactie-acc.cbs.nl/nl-nl/onze-diensten/voor-hoger-onderwijs/open-data/snelstartgids#


## Snelstartgids
```{r}
library(tidyverse)
library(jsonlite)

get_odata <- function(targetUrl) {
  data <- data.frame()
  
  while(!is.null(targetUrl)){
    response <- fromJSON(url(targetUrl))
    data <- bind_rows(data,response$value)
    targetUrl <- response[["@odata.nextLink"]]
  }
  return(data)
}

tableUrl <- "https://beta.opendata.cbs.nl/OData4/CBS/83765NED"
targetUrl <- paste0(tableUrl,"/Observations")
data <- get_odata(targetUrl)
head(data)
```

## Metadata

--> deze stap is dubbel: weglaten...
```{r, eval=FALSE}
tableUrl <- "https://beta.opendata.cbs.nl/OData4/CBS/83765NED"
targetUrl <- paste0(tableUrl,"/Observations")
data <- get_odata(targetUrl)
```

```{r}
## added meta as variable
meta <- get_odata(tableUrl)
```

## Groups
```{r}
groups <- get_odata(paste0(tableUrl,"/MeasureGroups"))
codes <- get_odata(paste0(tableUrl,"/MeasureCodes"))
```

## Join
```{r}
data <- data %>%
    left_join(codes, by=c("Measure"="Identifier")) %>%
    left_join(groups, by=c("MeasureGroupID"="ID"))
```

## Filters
```{r}
tableUrl <- "https://beta.opendata.cbs.nl/OData4/CBS/83765NED"
wijken_en_buurtencodes <- get_odata(paste0(tableUrl,"/WijkenEnBuurtenCodes"))
```

## Filter op Amsterdam
```{r}
wijken_en_buurtencodes_adam <- wijken_en_buurtencodes %>%
    filter(str_detect(Title, "Amsterdam"))
```

## GET
```{r}
targetUrl <- paste0(tableUrl,"/Observations?$filter=WijkenEnBuurten eq \'GM0363    \'")
data_amsterdam <- get_odata(targetUrl)
```

## Cartographic
```{r}
library(jsonlite)
library(geojsonio)
library(tidyverse)
library(sp)
download.file("https://geodata.nationaalgeoregister.nl/cbsgebiedsindelingen/wfs?request=GetFeature&service=WFS&version=2.0.0&typeName=cbs_gemeente_2017_gegeneraliseerd&outputFormat=json", destfile = "gemeenten2017.geojson")
gemeentegrenzen <- geojson_read(here::here("gemeenten2017.geojson"), what = "sp")
```

## Map
```{r}
tableUrl <- "https://beta.opendata.cbs.nl/OData4/CBS/83765NED"
codes <- get_odata(paste0(tableUrl,"/MeasureCodes"))
codes %>% filter(str_detect(Title,"Geboorte"))

targetUrl <- paste0(tableUrl,"/Observations?$filter=Measure eq \'M0000173_2\' and startswith(WijkenEnBuurten,\'GM\')")

geboorten_per_gemeente <- get_odata(targetUrl) %>% 
    mutate(WijkenEnBuurten = str_trim(WijkenEnBuurten)) %>%
    rename(relatieve_geboorte = Value)

head()

gemeentegrenzen@data <- gemeentegrenzen@data %>%
  left_join(geboorten_per_gemeente,by=c("statcode"="WijkenEnBuurten"))

g <- fortify(gemeentegrenzen, region = "id")
gemeentegrenzenDF <- merge(g, gemeentegrenzen@data, by = "id")

ggplot(data = gemeentegrenzenDF) +
  geom_polygon(aes(x=long, y=lat, group = group, fill = relatieve_geboorte)) +
  coord_equal()+
  ggtitle("Levend geborenen per 1000 inwoners, 2017") +
  theme_void()

```

## Tijdreeks
```{r}
# Bekijk welke metadata beschikbaar is
tableUrl <- "https://beta.opendata.cbs.nl/OData4/CBS/84120NED"
get_odata(tableUrl)

# Zoek de code van toeristenbelasting op
belastingCodes <- get_odata(paste0(tableUrl,"/BelastingenEnWettelijkePremiesCodes"))
belastingCodes %>% filter(str_detect(Title, "Toerist"))

# Haal de data op
targetUrl <- paste0(tableUrl,"/Observations?$filter=BelastingenEnWettelijkePremies eq 'A045081'")
data <- get_odata(targetUrl)

# Verwijder overbodige kolommen
data <- data %>% select(Perioden, Value)
```


## Split `Perioden`
```{r}
# Convert the time variable into either a date or numeric. 
cbs_add_date_column <- function(x, date_type = c("Date", "numeric"), period_name="Perioden",...){
  if (!period_name %in% colnames(x)){
    warning(paste("No time dimension found called",period_name))
    return(x)
  }
  
  period <- x[[period_name[1]]]
  PATTERN <- "(\\d{4})(\\w{2})(\\d{2})"
  
  year   <- as.integer(sub(PATTERN, "\\1", period))
  number <- as.integer(sub(PATTERN, "\\3", period))
  type   <- factor(sub(PATTERN, "\\2", period))
    
  # year conversion
  is_year <- type %in% c("JJ")
  is_quarter <- type %in% c("KW")
  is_month <- type %in% c("MM")
  
  # date
  date_type <- match.arg(date_type)
  
  if (date_type == "Date"){
    period <- as.POSIXct(character())
    period[is_year] <- ISOdate(year, 1, 1, tz="")[is_year]
    period[is_quarter] <- ISOdate(year, 1 + (number - 1) * 3, 1, tz="")[is_quarter]
    period[is_month] <- ISOdate(year, number, 1, tz="")[is_month]
    period <- as.Date(period)
  } else if (date_type == "numeric"){
    period <- numeric()
    period[is_year] <- year[is_year] + 0.5
    period[is_quarter] <- (year + (3*(number - 1) + 2) / 12)[is_quarter]
    period[is_month] <- (year + (number - 0.5) / 12)[is_month]
    if (all(is_year)){
      period <- as.integer(period)
    }
  }
  
  type1 <- factor(levels=c("Y","Q", "M"))
  type1[is_year] <- "Y"
  type1[is_quarter] <- "Q"
  type1[is_month] <- "M"
  type1 <- droplevels(type1)
  
  # put the column just behind the period column
  i <- which(names(x) == period_name)
  x <- x[c(1:i, i, i:ncol(x))]
  idx <- c(i+1, i+2)
  x[idx] <- list(period, type1)
  names(x)[idx] <- paste0(period_name, paste0("_", c(date_type,"freq")))
  x
}

#De functie cbs_add_date_column voegt een kolom toe met het type van de periode (maand/kwartaal/jaar) en een kolom met de startdatum van de periode. Na het filteren op jaarcijfers kan er een grafiek van de data worden gemaakt met bijvoorbeeld ggplot2.

# Datumconversie en selectie van jaarcijfers
data <- data %>% cbs_add_date_column() 
jaarcijfers <- data %>% filter(Perioden_freq == "Y")

# Plot de tijdreeks
ggplot(jaarcijfers, aes(x=Perioden_Date, y=Value)) +
  geom_line() + 
  ylim(0,250)+
  
  labs(title = "Opbrengst toeristenbelasting per jaar", x = "", y = "mln euro",
       caption = "Bron: CBS")
```





## Tips

 - Write specific R-package / Python library with functionality to get open data from CBS
 - Provide way to limit results in first instance in the documentation
 - Provide download link for Rmd or Jupyter notebook file with complete walkthrough
 - add meta as variable in global Env.
 - do not overwrite data with filtered data, create new colum (lgl), or create new table in global env.
 - Use the word 'escape' in stead of 'gecompenseerd'
 - list with tables or datasets? Where can I get information on what I will be able to access through this tool 
 - in stead of pointing using `getwd()` point people to the here package `here::here()`
 https://github.com/jennybc/here_here 
 - include the download of the json file in the code, it was unclear to me that I needed to download something manually and it also counterintuitive to the rest of the demo (not in spirit of using an API)
 - include saving the plot to disk in the demo
 
 - To add on to this: maybe provide some demostrations on statistical methods and operations on the downloaded data for instruction and inspiration puposes.
 
 - Provide a Machine Learning example on another dataset (multivariate)
 - Convert variable `Perioden` to year is easier using `separate()`
